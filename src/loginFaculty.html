<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faculty Login – Tabgha School Survey</title>

  <!-- Local preview CSS -->
  <link
    id="localStylesheet"
    rel="stylesheet"
    href="../docs/style.css"
  />

  <!-- Hosted CSS for production -->
  <link
    id="gasStylesheet"
    rel="stylesheet"
    href="https://steph7n.github.io/tec-survey-assets/style.css"
  />
</head>

<body data-base-url="<?= baseUrl ?>">
  <!-- Top Bar -->
  <header class="app-bar">
    <img
      id="app-logo"
      alt="School Logo"
      class="app-bar__logo"
      src="../docs/school-logo.png"
    />
    <div id="app-title" class="app-bar__title"></div>
  </header>

  <main class="page-container">
    <section class="page-content">
      <div class="card card--centered login-card" id="login-card">

        <!-- Dynamic content inserted by JS -->
        <div id="login-content" class="login-dynamic"></div>

      </div>
    </section>
  </main>

  <script>
    (function () {
      var host = window.location.hostname;
      var isLocal =
        host === "localhost" ||
        host === "127.0.0.1" ||
        host.endsWith(".github.io");

      // Toggle CSS source
      var localCss = document.getElementById("localStylesheet");
      var gasCss = document.getElementById("gasStylesheet");
      if (localCss && gasCss) {
        if (isLocal) {
          gasCss.disabled = true;
        } else {
          localCss.disabled = true;
        }
      }

      // Swap logo source when remote
      var logo = document.getElementById("app-logo");
      if (logo && !isLocal) {
        logo.src = "https://steph7n.github.io/tec-survey-assets/school-logo.png";
      }

      const baseUrl =
        (document.body && document.body.getAttribute("data-base-url")) || "";
      const isWebApp =
        typeof baseUrl === "string" && baseUrl.startsWith("http");

      const accountChooserUrl = baseUrl
        ? "https://accounts.google.com/AccountChooser?continue=" +
          encodeURIComponent(baseUrl + "?page=loginFaculty")
        : "";

      // Set dynamic top bar title
      const titleEl = document.getElementById("app-title");
      const currentYear = new Date().getFullYear();
      if (titleEl) {
        titleEl.textContent =
          "School Survey " + currentYear;
      }

      const contentEl = document.getElementById("login-content");

      function render(html) {
        if (contentEl) contentEl.innerHTML = html;
      }

      function gotoPage(pageName) {
        if (!baseUrl) return;
        // e.g. https://script.google.com/.../exec?page=admin
        window.location.href = baseUrl + "?page=" + encodeURIComponent(pageName);
      }

      // Local preview (opened directly from file system)
      if (!isWebApp || typeof google === "undefined" || !google.script || !google.script.run) {
        render(`
          <h1 class="card-title">Faculty / Student Login</h1>
          <p class="form-label">Local preview only.</p>
          <p class="text-hint">In live mode, this page checks your Google Workspace account and redirects you to the correct survey page.</p>
        `);
        return;
      }

      // Initial loading state
      render(`
        <h1 class="card-title">Faculty / Student Login</h1>
        <p class="form-label">Checking your account…</p>
      `);

      google.script.run
        .withSuccessHandler(function (result) {
          if (!result) {
            render('<p class="form-error">Unexpected error.</p>');
            return;
          }

          // 1. Not logged in / no email
          if (!result.loggedIn) {
            render(`
              <h1 class="card-title">Faculty / Student Login</h1>
              <p class="form-label">
                Please make sure you are signed in to your
                <strong>@tabgha.education</strong> Google account in this browser,
                then tap the button below.
              </p>
              <a
                class="btn btn--primary btn--block"
                id="btn-login"
                href="${accountChooserUrl}"
                target="_blank"
                rel="noopener"
              >
                Sign In / Switch Account
              </a>
            `);
            return;
          }

          // 2. Logged in but wrong domain
          if (!result.validDomain) {
            render(`
              <h1 class="card-title">Wrong Account</h1>
              <p class="form-error">
                You are currently signed in as <strong>${result.email}</strong>.<br>
                This account cannot access the survey.<br><br>
                Please sign in with your <strong>@tabgha.education</strong> account
                in this browser, then click the button below.
              </p>
              <a
                class="btn btn--primary btn--block"
                id="btn-switch"
                href="${accountChooserUrl}"
                target="_blank"
                rel="noopener"
              >
                Sign In / Switch Account
              </a>
            `);
            return;
          }

          // 3. Valid domain → route by status
          if (result.status === "superadmin") {
            gotoPage("admin");
            return;
          }

          if (result.status === "faculty" || result.status === "student") {
            gotoPage("surveyHome");
            return;
          }

          if (result.status === "inactive") {
            gotoPage("surveyInactive");
            return;
          }

          // Fallback
          render('<p class="form-error">Unknown login state.</p>');
        })
        .withFailureHandler(function (err) {
          console.error(err);
          render('<p class="form-error">Error while checking your account.</p>');
        })
        .checkFacultyLoginStatus();
    })();
  </script>
</body>
</html>
